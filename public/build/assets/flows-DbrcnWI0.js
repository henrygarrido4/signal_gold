import{L as O}from"./main-BZMVmuB9.js";import{P as K}from"./page-header-CWp0LBfO.js";import{H as b,r as m,o as c,d as E,f as s,t as u,a,w as r,h as _,F as R,g as z,c as B,n as N,e as f,D as J,x as X,k as q}from"./app-BWABJYdq.js";import{S}from"./sweetalert2.esm.all-CumHaNCI.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./simplebar-vue.esm-CZuBtKrH.js";import"./avatar-2-C9CWE8xV.js";import"./avatar-3-CcIxMpdW.js";import"./avatar-5-BPjc6EDL.js";import"./russia-pMTSjNGF.js";import"./logo-signal-9z7U6Iga.js";import"./logo-dark-BbIT5rJd.js";import"./logo-light-BfYujB8V.js";const Q={name:"FlowEmails",emits:["update:emails","refresh"],props:{selectedFlow:{type:Object,required:!0}},data(){return{showNewEmailModal:!1,showEditEmailModal:!1,showImagePreviewModal:!1,editingEmail:null,newEmail:{name:"",subject:"",delay:"",template:"default",workflow_name:"",workflow_url:"",campaign_id:"",email_link:"",send_list:"",suppression_lists:"",description:""},errors:{name:"",subject:"",image:"",workflow_url:"",email_link:""},selectedImage:null,imagePreview:null,previewImageUrl:null,previewImageTitle:"",currentPreviewEmailIndex:null,isSaving:!1,isDeleting:!1,imageZoom:1,minZoom:.5,maxZoom:3,isDragging:!1,startX:0,startY:0,translateX:0,translateY:0,lastX:0,lastY:0,dragVelocity:{x:0,y:0},isZoomed:!1,zoomLevel:2}},computed:{emailName:{get(){return this.editingEmail?this.editingEmail.name:this.newEmail.name},set(e){this.editingEmail?this.editingEmail.name=e:this.newEmail.name=e}},emailSubject:{get(){return this.editingEmail?this.editingEmail.subject:this.newEmail.subject},set(e){this.editingEmail?this.editingEmail.subject=e:this.newEmail.subject=e}},emailDelay:{get(){return this.editingEmail?this.editingEmail.delay:this.newEmail.delay},set(e){this.editingEmail?this.editingEmail.delay=e:this.newEmail.delay=e}},defaultImage(){return"/images/email-templates/default.jpg"},currentPreviewEmail(){var t;return this.currentPreviewEmailIndex===null||!((t=this.selectedFlow)!=null&&t.emails)?null:this.selectedFlow.emails[this.currentPreviewEmailIndex]},hasPreviousEmail(){return this.currentPreviewEmailIndex>0},hasNextEmail(){var e;return(e=this.selectedFlow)!=null&&e.emails?this.currentPreviewEmailIndex<this.selectedFlow.emails.length-1:!1},emailWorkflowName:{get(){return this.editingEmail?this.editingEmail.workflow_name:this.newEmail.workflow_name},set(e){this.editingEmail?this.editingEmail.workflow_name=e:this.newEmail.workflow_name=e}},emailWorkflowUrl:{get(){return this.editingEmail?this.editingEmail.workflow_url:this.newEmail.workflow_url},set(e){this.editingEmail?this.editingEmail.workflow_url=e:this.newEmail.workflow_url=e}},emailCampaignId:{get(){return this.editingEmail?this.editingEmail.campaign_id:this.newEmail.campaign_id},set(e){this.editingEmail?this.editingEmail.campaign_id=e:this.newEmail.campaign_id=e}},emailLink:{get(){return this.editingEmail?this.editingEmail.email_link:this.newEmail.email_link},set(e){this.editingEmail?this.editingEmail.email_link=e:this.newEmail.email_link=e}},emailSendList:{get(){return this.editingEmail?this.editingEmail.send_list:this.newEmail.send_list},set(e){this.editingEmail?this.editingEmail.send_list=e:this.newEmail.send_list=e}},emailSuppressionLists:{get(){return this.editingEmail?this.editingEmail.suppression_lists:this.newEmail.suppression_lists},set(e){this.editingEmail?this.editingEmail.suppression_lists=e:this.newEmail.suppression_lists=e}},emailDescription:{get(){return this.editingEmail?this.editingEmail.description:this.newEmail.description},set(e){this.editingEmail?this.editingEmail.description=e:this.newEmail.description=e}}},methods:{addEmailToFlow(){this.resetEmailForm(),this.clearFileInput(),this.showNewEmailModal=!0},editEmail(e){this.editingEmail={...e},this.clearFileInput(),this.showEditEmailModal=!0},async saveEmail(){var n,d,l,i,w,p;this.isSaving=!0;const e=new FormData,t=this.editingEmail||this.newEmail;e.append("name",t.name),e.append("subject",t.subject),e.append("delay",t.delay),e.append("flow_id",this.selectedFlow.id),this.selectedImage&&e.append("image",this.selectedImage),(n=t.workflow_url)!=null&&n.trim()&&e.append("workflow_url",t.workflow_url.trim()),(d=t.email_link)!=null&&d.trim()&&e.append("email_link",t.email_link.trim()),e.append("workflow_name",t.workflow_name||""),e.append("campaign_id",t.campaign_id||""),e.append("send_list",t.send_list||""),e.append("suppression_lists",t.suppression_lists||""),e.append("description",t.description||"");for(let g of e.entries());try{let g;const y=`/flows/${this.selectedFlow.id}/emails`;if(this.editingEmail){const k=`${y}/${this.editingEmail.id}`;e.append("_method","PUT"),g=await b.post(k,e,{headers:{"Content-Type":"multipart/form-data"}});const x=this.selectedFlow.emails.map(D=>D.id===g.data.id?g.data:D);this.$emit("update:emails",x)}else{g=await b.post(y,e,{headers:{"Content-Type":"multipart/form-data"}});const k=[...this.selectedFlow.emails,g.data];this.$emit("update:emails",k)}this.showSuccessAlert(this.editingEmail?"Email updated successfully!":"Email added successfully!"),this.resetEmailForm()}catch(g){if(console.error("Error in saveEmail:",g),(i=(l=g.response)==null?void 0:l.data)!=null&&i.errors){const{name:y,subject:k,image:x}=g.response.data.errors;this.errors={name:y,subject:k,image:x}}else this.showErrorAlert(((p=(w=g.response)==null?void 0:w.data)==null?void 0:p.message)||"Failed to save email. Please try again.")}finally{this.isSaving=!1}},handleImageUpload(e){const t=e.target.files[0];t&&(this.selectedImage=t,this.imagePreview=URL.createObjectURL(t))},clearFileInput(){this.$refs.fileInput&&(this.$refs.fileInput.value=""),this.selectedImage=null,this.imagePreview=null},confirmDelete(e){S.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#34c38f",cancelButtonColor:"#f46a6a",confirmButtonText:"Yes, delete it!"}).then(t=>{t.isConfirmed&&this.handleDelete(e)})},async handleDelete(e){var t,n;if(!this.isDeleting){this.isDeleting=!0;try{const d=this.selectedFlow.emails.filter(l=>l.id!==e.id);this.$emit("update:emails",d),await b.delete(`/flows/${this.selectedFlow.id}/emails/${e.id}`),this.showSuccessAlert("Email deleted successfully")}catch(d){console.error("Error deleting email:",d),this.showErrorAlert(((n=(t=d.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to delete email"),this.$emit("refresh")}finally{this.isDeleting=!1}}},viewEmailTemplate(e){this.currentPreviewEmailIndex=this.selectedFlow.emails.findIndex(t=>t.id===e.id),this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage,this.showImagePreviewModal=!0},showPreviousEmail(){if(this.hasPreviousEmail){this.resetZoom(),this.currentPreviewEmailIndex--;const e=this.selectedFlow.emails[this.currentPreviewEmailIndex];this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage}},showNextEmail(){if(this.hasNextEmail){this.resetZoom(),this.currentPreviewEmailIndex++;const e=this.selectedFlow.emails[this.currentPreviewEmailIndex];this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage}},formatDelay(e){return e||""},showSuccessAlert(e){S.fire({title:"Success!",text:e,icon:"success",showConfirmButton:!1,timer:1500,timerProgressBar:!0})},showErrorAlert(e){S.fire({title:"Error!",text:e,icon:"error",confirmButtonColor:"#34c38f",confirmButtonText:"Ok"})},resetEmailForm(){this.showNewEmailModal=!1,this.showEditEmailModal=!1,this.editingEmail=null,this.newEmail={name:"",subject:"",delay:"",template:"default",workflow_name:"",workflow_url:"",campaign_id:"",email_link:"",send_list:"",suppression_lists:"",description:""},this.errors={name:"",subject:"",image:"",workflow_url:"",email_link:""},this.clearFileInput()},getImageName(){var e;return(e=this.editingEmail)!=null&&e.image_path?this.editingEmail.original_name?this.editingEmail.original_name:"Current template image":this.selectedImage?this.selectedImage.name:"Choose an image"},toggleZoom(){this.isZoomed=!this.isZoomed,this.imageZoom=this.isZoomed?this.zoomLevel:1,this.isZoomed||this.resetPosition()},resetZoom(){this.imageZoom=1,this.resetPosition()},startDrag(e){this.imageZoom<=1||(this.isDragging=!0,this.startX=e.clientX-this.translateX,this.startY=e.clientY-this.translateY,document.body.style.cursor="grabbing",document.body.style.userSelect="none",this.$refs.previewImage.classList.add("dragging"))},doDrag(e){this.isDragging&&(e.preventDefault(),requestAnimationFrame(()=>{const t=e.clientX-this.startX,n=e.clientY-this.startY,d=this.$refs.imageContainer.getBoundingClientRect(),l=this.$refs.previewImage.getBoundingClientRect(),i=(l.width*this.imageZoom-d.width)/2,w=(l.height*this.imageZoom-d.height)/2;this.translateX=Math.max(Math.min(t,i),-i),this.translateY=Math.max(Math.min(n,w),-w)}))},stopDrag(){this.isDragging&&(this.isDragging=!1,document.body.style.cursor="",document.body.style.userSelect="",this.$refs.previewImage.classList.remove("dragging"))},applyMomentum(){const t=()=>{if(Math.abs(this.dragVelocity.x)<.1&&Math.abs(this.dragVelocity.y)<.1)return;this.dragVelocity.x*=.95,this.dragVelocity.y*=.95;const n=this.translateX+this.dragVelocity.x,d=this.translateY+this.dragVelocity.y,l=this.$refs.imageContainer.getBoundingClientRect(),i=this.$refs.previewImage.getBoundingClientRect(),w=(i.width*this.imageZoom-l.width)/2,p=(i.height*this.imageZoom-l.height)/2;this.translateX=Math.max(Math.min(n,w),-w),this.translateY=Math.max(Math.min(d,p),-p),requestAnimationFrame(t)};requestAnimationFrame(t)},resetPosition(){this.translateX=0,this.translateY=0,this.lastX=0,this.lastY=0},shouldShowField(e){return e&&e!=="null"&&e!==null&&e.toString().trim()!==""}}},$={class:"d-flex align-items-center mb-4"},ee={class:"flex-grow-1"},te={class:"card-title mb-0"},ie={class:"text-muted mb-0"},le={class:"flex-shrink-0"},se={class:"flow-container"},ae={class:"d-flex align-items-center"},re={class:"email-number me-2"},oe={class:"card-title mb-0"},ne={class:"card-text mb-2"},me={class:"card-text"},de={class:"text-muted"},ue={class:"d-flex align-items-center mt-auto"},ce=["src","alt"],he={class:"input-group"},we=["state"],ge={key:0,class:"input-group-text"},fe={class:"d-flex gap-2"},pe={class:"email-preview-header w-100"},Ee={class:"modal-title"},_e={class:"preview-details bg-light p-3 rounded mt-3"},ve={class:"row g-3"},Fe={key:0,class:"col-12"},be={class:"preview-detail-item"},ye={key:1,class:"col-12"},ke={class:"preview-detail-item"},Ie={key:2,class:"col-md-6"},xe={class:"preview-detail-item"},Pe=["href"],Be={key:1},Ce={key:3,class:"col-md-6"},De={class:"preview-detail-item"},Ve={key:4,class:"col-md-6"},Te={class:"preview-detail-item"},Se=["href"],Me={key:5,class:"col-md-6"},Ne={class:"preview-detail-item"},je={key:6,class:"col-12"},Ue={class:"preview-detail-item"},Le={key:7,class:"col-12"},Ae={class:"preview-detail-item"},Ze={class:"mb-0"},Ye={class:"zoom-controls"},Xe=["src","alt"];function Re(e,t,n,d,l,i){const w=m("BButton"),p=m("BCardHeader"),g=m("BDropdownItem"),y=m("BDropdown"),k=m("BCardBody"),x=m("BCol"),D=m("BRow"),j=m("BCard"),I=m("BFormInput"),C=m("BFormInvalidFeedback"),F=m("BFormGroup"),U=m("BFormTextarea"),Y=m("BForm"),V=m("BModal");return c(),E(R,null,[s("div",$,[s("div",ee,[s("h5",te,u(n.selectedFlow.name)+" Flow",1),s("p",ie,u(n.selectedFlow.description),1)]),s("div",le,[a(w,{variant:"soft-primary",size:"sm",onClick:i.addEmailToFlow},{default:r(()=>t[25]||(t[25]=[s("i",{class:"ri-mail-add-line align-middle me-1"},null,-1),_(" Add Email ")])),_:1},8,["onClick"])])]),s("div",se,[(c(!0),E(R,null,z(n.selectedFlow.emails,(o,v)=>(c(),B(x,{key:o.id,class:"email-step"},{default:r(()=>[a(j,{"no-body":"",class:"card-animate"},{default:r(()=>[a(D,{class:"g-0"},{default:r(()=>[a(x,{md:"8"},{default:r(()=>[a(p,null,{default:r(()=>[s("div",ae,[s("span",re,u(v+1),1),s("h5",oe,u(o.name),1)])]),_:2},1024),a(k,null,{default:r(()=>[s("p",ne,u(o.subject||"No subject"),1),s("p",me,[s("small",de,[t[26]||(t[26]=s("i",{class:"ri-time-line align-middle me-1"},null,-1)),_(" Sends: "+u(i.formatDelay(o.delay)),1)])]),s("div",ue,[a(y,{variant:"link","drop-up":"","toggle-class":"btn btn-soft-primary btn-sm arrow-none","menu-class":"dropdown-menu-end"},{"button-content":r(()=>t[27]||(t[27]=[s("i",{class:"ri-more-2-fill"},null,-1)])),default:r(()=>[a(g,{onClick:P=>i.viewEmailTemplate(o)},{default:r(()=>t[28]||(t[28]=[s("i",{class:"ri-eye-line align-bottom me-2 text-muted"},null,-1),_("View ")])),_:2},1032,["onClick"]),a(g,{onClick:P=>i.editEmail(o)},{default:r(()=>t[29]||(t[29]=[s("i",{class:"ri-edit-line align-bottom me-2 text-muted"},null,-1),_("Edit ")])),_:2},1032,["onClick"]),a(g,{onClick:P=>i.confirmDelete(o),disabled:l.isDeleting,class:"text-danger"},{default:r(()=>t[30]||(t[30]=[s("i",{class:"ri-delete-bin-line align-bottom me-2 text-muted"},null,-1),_("Delete ")])),_:2},1032,["onClick","disabled"])]),_:2},1024)])]),_:2},1024)]),_:2},1024),a(x,{md:"4",class:"email-image-col"},{default:r(()=>[s("img",{class:"img-fluid",src:o.image_path?`/storage/${o.image_path}`:i.defaultImage,alt:`${o.name} template preview`,onError:t[0]||(t[0]=(...P)=>e.handleImageError&&e.handleImageError(...P))},null,40,ce)]),_:2},1024)]),_:2},1024)]),_:2},1024),v<n.selectedFlow.emails.length-1?(c(),E("div",{key:0,class:N(["flow-arrow",{"flow-arrow-down":(v+1)%4===0,"flow-arrow-right":(v+1)%4!==0&&Math.floor(v/4)%2===0,"flow-arrow-left":(v+1)%4!==0&&Math.floor(v/4)%2===1}])},[s("i",{class:N(["bx",{"bx-right-arrow-alt":(v+1)%4!==0&&Math.floor(v/4)%2===0,"bx-left-arrow-alt":(v+1)%4!==0&&Math.floor(v/4)%2===1,"bx-down-arrow-alt":(v+1)%4===0}])},null,2)],2)):f("",!0)]),_:2},1024))),128))]),a(V,{modelValue:l.showNewEmailModal||l.showEditEmailModal,title:l.editingEmail?"Edit Email":"Add New Email",onHide:i.resetEmailForm},{footer:r(()=>[a(w,{variant:"secondary",onClick:i.resetEmailForm},{default:r(()=>t[33]||(t[33]=[_(" Cancel ")])),_:1},8,["onClick"]),a(w,{variant:"primary",onClick:i.saveEmail,disabled:l.isSaving},{default:r(()=>[_(u(l.editingEmail?"Update":"Add"),1)]),_:1},8,["onClick","disabled"])]),default:r(()=>[a(Y,null,{default:r(()=>[a(F,{label:"Email Name*",class:"mb-3"},{default:r(()=>[a(I,{modelValue:i.emailName,"onUpdate:modelValue":t[1]||(t[1]=o=>i.emailName=o),placeholder:"Enter email name",state:l.errors.name?!1:null},null,8,["modelValue","state"]),l.errors.name?(c(),B(C,{key:0},{default:r(()=>[_(u(l.errors.name),1)]),_:1})):f("",!0)]),_:1}),a(F,{label:"Subject Line*",class:"mb-3"},{default:r(()=>[a(I,{modelValue:i.emailSubject,"onUpdate:modelValue":t[2]||(t[2]=o=>i.emailSubject=o),placeholder:"Enter subject line",state:l.errors.subject?!1:null},null,8,["modelValue","state"]),l.errors.subject?(c(),B(C,{key:0},{default:r(()=>[_(u(l.errors.subject),1)]),_:1})):f("",!0)]),_:1}),a(F,{label:"Send Delay*",class:"mb-3"},{default:r(()=>[a(I,{modelValue:i.emailDelay,"onUpdate:modelValue":t[3]||(t[3]=o=>i.emailDelay=o),placeholder:"Enter when this email should be sent"},null,8,["modelValue"]),t[31]||(t[31]=s("small",{class:"text-muted"},' Example: "Send immediately", "2 days after signup", "When user completes profile" ',-1))]),_:1}),a(F,{label:"Template Image"},{default:r(()=>{var o;return[s("div",he,[s("input",{ref:"fileInput",type:"file",class:"form-control",accept:"image/*",onChange:t[4]||(t[4]=(...v)=>i.handleImageUpload&&i.handleImageUpload(...v)),state:l.errors.image?!1:null},null,40,we),(o=l.editingEmail)!=null&&o.image_path||l.selectedImage?(c(),E("span",ge,u(i.getImageName()),1)):f("",!0)]),l.errors.image?(c(),B(C,{key:0},{default:r(()=>[_(u(l.errors.image),1)]),_:1})):f("",!0)]}),_:1}),t[32]||(t[32]=s("hr",{class:"my-4"},null,-1)),a(F,{class:"mb-3",label:"Workflow Name & URL"},{default:r(()=>[s("div",fe,[a(I,{modelValue:i.emailWorkflowName,"onUpdate:modelValue":t[5]||(t[5]=o=>i.emailWorkflowName=o),placeholder:"Workflow Name"},null,8,["modelValue"]),a(I,{modelValue:i.emailWorkflowUrl,"onUpdate:modelValue":t[6]||(t[6]=o=>i.emailWorkflowUrl=o),placeholder:"Workflow URL",type:"url"},null,8,["modelValue"])]),a(C,{state:!l.errors.workflow_url},{default:r(()=>[_(u(l.errors.workflow_url),1)]),_:1},8,["state"])]),_:1}),a(F,{class:"mb-3",label:"Campaign ID"},{default:r(()=>[a(I,{modelValue:i.emailCampaignId,"onUpdate:modelValue":t[7]||(t[7]=o=>i.emailCampaignId=o),placeholder:"Campaign ID",type:"text"},null,8,["modelValue"])]),_:1}),a(F,{class:"mb-3",label:"Email Link"},{default:r(()=>[a(I,{modelValue:i.emailLink,"onUpdate:modelValue":t[8]||(t[8]=o=>i.emailLink=o),placeholder:"Email URL",type:"url"},null,8,["modelValue"]),a(C,{state:!l.errors.email_link},{default:r(()=>[_(u(l.errors.email_link),1)]),_:1},8,["state"])]),_:1}),a(F,{class:"mb-3",label:"Send List"},{default:r(()=>[a(I,{modelValue:i.emailSendList,"onUpdate:modelValue":t[9]||(t[9]=o=>i.emailSendList=o),placeholder:"Send List"},null,8,["modelValue"])]),_:1}),a(F,{class:"mb-3",label:"Suppression Lists"},{default:r(()=>[a(U,{modelValue:i.emailSuppressionLists,"onUpdate:modelValue":t[10]||(t[10]=o=>i.emailSuppressionLists=o),placeholder:"Enter suppression lists",rows:"2"},null,8,["modelValue"])]),_:1}),a(F,{class:"mb-3",label:"Description"},{default:r(()=>[a(U,{modelValue:i.emailDescription,"onUpdate:modelValue":t[11]||(t[11]=o=>i.emailDescription=o),placeholder:"Enter description",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","title","onHide"]),a(V,{modelValue:l.showImagePreviewModal,"onUpdate:modelValue":t[24]||(t[24]=o=>l.showImagePreviewModal=o),size:"xl",class:"email-preview-modal","hide-footer":""},{header:r(()=>{var o,v,P,L,A,Z,h,T,M;return[s("div",pe,[s("h5",Ee,u(l.previewImageTitle),1),s("div",_e,[s("div",ve,[(o=i.currentPreviewEmail)!=null&&o.subject?(c(),E("div",Fe,[s("div",be,[t[34]||(t[34]=s("small",{class:"text-muted d-block"},"Subject Line",-1)),s("span",null,u(i.currentPreviewEmail.subject),1)])])):f("",!0),(v=i.currentPreviewEmail)!=null&&v.delay?(c(),E("div",ye,[s("div",ke,[t[35]||(t[35]=s("small",{class:"text-muted d-block"},"Send Delay",-1)),s("span",null,u(i.formatDelay(i.currentPreviewEmail.delay)),1)])])):f("",!0),(P=i.currentPreviewEmail)!=null&&P.workflow_name||(L=i.currentPreviewEmail)!=null&&L.workflow_url?(c(),E("div",Ie,[s("div",xe,[t[36]||(t[36]=s("small",{class:"text-muted d-block"},"Workflow",-1)),i.currentPreviewEmail.workflow_url?(c(),E("a",{key:0,href:i.currentPreviewEmail.workflow_url,target:"_blank",class:"text-primary"},u(i.currentPreviewEmail.workflow_name||"View Workflow"),9,Pe)):(c(),E("span",Be,u(i.currentPreviewEmail.workflow_name),1))])])):f("",!0),(A=i.currentPreviewEmail)!=null&&A.campaign_id?(c(),E("div",Ce,[s("div",De,[t[37]||(t[37]=s("small",{class:"text-muted d-block"},"Campaign ID",-1)),s("span",null,u(i.currentPreviewEmail.campaign_id),1)])])):f("",!0),(Z=i.currentPreviewEmail)!=null&&Z.email_link?(c(),E("div",Ve,[s("div",Te,[t[38]||(t[38]=s("small",{class:"text-muted d-block"},"Email Link",-1)),s("a",{href:i.currentPreviewEmail.email_link,target:"_blank",class:"text-primary"}," View Email ",8,Se)])])):f("",!0),(h=i.currentPreviewEmail)!=null&&h.send_list&&i.currentPreviewEmail.send_list!=="null"?(c(),E("div",Me,[s("div",Ne,[t[39]||(t[39]=s("small",{class:"text-muted d-block"},"Send List",-1)),s("span",null,u(i.currentPreviewEmail.send_list),1)])])):f("",!0),i.shouldShowField((T=i.currentPreviewEmail)==null?void 0:T.suppression_lists)?(c(),E("div",je,[s("div",Ue,[t[40]||(t[40]=s("small",{class:"text-muted d-block"},"Suppression Lists",-1)),s("span",null,u(i.currentPreviewEmail.suppression_lists),1)])])):f("",!0),i.shouldShowField((M=i.currentPreviewEmail)==null?void 0:M.description)?(c(),E("div",Le,[s("div",Ae,[t[41]||(t[41]=s("small",{class:"text-muted d-block"},"Description",-1)),s("p",Ze,u(i.currentPreviewEmail.description),1)])])):f("",!0)])])])]}),default:r(()=>[s("div",{class:"text-center position-relative preview-container",tabindex:"0",onKeyup:[t[21]||(t[21]=X(o=>i.hasPreviousEmail&&i.showPreviousEmail(),["left"])),t[22]||(t[22]=X(o=>i.hasNextEmail&&i.showNextEmail(),["right"])),t[23]||(t[23]=X(o=>l.showImagePreviewModal=!1,["esc"]))]},[s("div",Ye,[s("button",{class:"btn btn-icon btn-soft-primary",onClick:t[12]||(t[12]=(...o)=>i.toggleZoom&&i.toggleZoom(...o))},[s("i",{class:N(l.isZoomed?"ri-zoom-out-line":"ri-zoom-in-line")},null,2)]),s("button",{class:"btn btn-icon btn-soft-secondary",onClick:t[13]||(t[13]=(...o)=>i.resetZoom&&i.resetZoom(...o))},t[42]||(t[42]=[s("i",{class:"ri-refresh-line"},null,-1)]))]),i.hasPreviousEmail?(c(),E("button",{key:0,class:"btn btn-icon btn-soft-light preview-nav-btn preview-nav-prev",onClick:t[14]||(t[14]=(...o)=>i.showPreviousEmail&&i.showPreviousEmail(...o))},t[43]||(t[43]=[s("i",{class:"bx bx-chevron-left"},null,-1)]))):f("",!0),s("div",{ref:"imageContainer",class:N(["image-container",{"can-drag":l.imageZoom>1}]),onMousedown:t[16]||(t[16]=(...o)=>i.startDrag&&i.startDrag(...o)),onMousemove:t[17]||(t[17]=(...o)=>i.doDrag&&i.doDrag(...o)),onMouseup:t[18]||(t[18]=(...o)=>i.stopDrag&&i.stopDrag(...o)),onMouseleave:t[19]||(t[19]=(...o)=>i.stopDrag&&i.stopDrag(...o))},[s("img",{ref:"previewImage",src:l.previewImageUrl,class:"preview-image",style:J({transform:`scale(${l.imageZoom}) translate3d(${l.translateX/l.imageZoom}px, ${l.translateY/l.imageZoom}px, 0)`,cursor:l.imageZoom>1?l.isDragging?"grabbing":"grab":"default"}),onError:t[15]||(t[15]=(...o)=>e.handleImageError&&e.handleImageError(...o)),alt:l.previewImageTitle,draggable:"false"},null,44,Xe)],34),i.hasNextEmail?(c(),E("button",{key:1,class:"btn btn-icon btn-soft-light preview-nav-btn preview-nav-next",onClick:t[20]||(t[20]=(...o)=>i.showNextEmail&&i.showNextEmail(...o))},t[44]||(t[44]=[s("i",{class:"bx bx-chevron-right"},null,-1)]))):f("",!0)],32)]),_:1},8,["modelValue"])],64)}const We=H(Q,[["render",Re],["__scopeId","data-v-08011696"]]),qe={components:{Layout:O,PageHeader:K,FlowEmails:We},data(){return{searchTerm:"",selectedFlow:null,showNewFlowModal:!1,showEditFlowModal:!1,showNewEmailModal:!1,showEditEmailModal:!1,editingFlow:null,editingEmail:null,newFlow:{name:"",description:"",status:"draft"},newEmail:{name:"",subject:"",delay:"",template:"default"},flows:[],isLoading:!1,isDeleting:!1,isSaving:!1,isProcessing:!1,clickTimeout:null,itemToDelete:null,deleteType:null,errors:{flow:{name:"",description:"",status:""},email:{name:"",subject:"",delay:"",image:""}},templateImages:{default:"/images/email-templates/default.jpg","welcome-template":"/images/email-templates/welcome.jpg","product-intro":"/images/email-templates/product.jpg"},selectedImage:null,imagePreview:null,showImagePreviewModal:!1,previewImageUrl:null,previewImageTitle:"",currentPreviewEmailIndex:null,currentPage:1,perPage:6}},computed:{flowName:{get(){return this.editingFlow?this.editingFlow.name:this.newFlow.name},set(e){this.editingFlow?this.editingFlow.name=e:this.newFlow.name=e}},flowDescription:{get(){return this.editingFlow?this.editingFlow.description:this.newFlow.description},set(e){this.editingFlow?this.editingFlow.description=e:this.newFlow.description=e}},flowStatus:{get(){return this.editingFlow?this.editingFlow.status:this.newFlow.status},set(e){this.editingFlow?this.editingFlow.status=e:this.newFlow.status=e}},emailName:{get(){return this.editingEmail?this.editingEmail.name:this.newEmail.name},set(e){this.editingEmail?this.editingEmail.name=e:this.newEmail.name=e}},emailSubject:{get(){return this.editingEmail?this.editingEmail.subject:this.newEmail.subject},set(e){this.editingEmail?this.editingEmail.subject=e:this.newEmail.subject=e}},emailDelay:{get(){return this.editingEmail?this.editingEmail.delay:this.newEmail.delay},set(e){this.editingEmail?this.editingEmail.delay=e:this.newEmail.delay=e}},emailTemplate:{get(){return this.editingEmail?this.editingEmail.template:this.newEmail.template},set(e){this.editingEmail?this.editingEmail.template=e:this.newEmail.template=e}},getTemplateImage(){return e=>this.templateImages[e]||this.templateImages.default},defaultImage(){return"/images/email-templates/default.jpg"},currentPreviewEmail(){var e;return this.currentPreviewEmailIndex===null?null:(e=this.selectedFlow)==null?void 0:e.emails[this.currentPreviewEmailIndex]},hasPreviousEmail(){return this.currentPreviewEmailIndex>0},hasNextEmail(){var e;return this.currentPreviewEmailIndex<((e=this.selectedFlow)==null?void 0:e.emails.length)-1},filteredFlows(){if(!this.searchTerm)return this.flows;const e=this.searchTerm.toLowerCase();return this.flows.filter(t=>{var n;return t.name.toLowerCase().includes(e)||((n=t.description)==null?void 0:n.toLowerCase().includes(e))||t.status.toLowerCase().includes(e)})},paginatedFlows(){if(this.searchTerm)return this.filteredFlows;const e=(this.currentPage-1)*this.perPage,t=e+this.perPage;return this.flows.slice(e,t)},totalPages(){const e=this.searchTerm?this.filteredFlows.length:this.flows.length;return Math.ceil(e/this.perPage)},showPagination(){return!this.searchTerm&&this.flows.length>this.perPage}},mounted(){this.refreshFlows()},methods:{handleClick(e,...t){if(!this.clickTimeout)return this.clickTimeout=setTimeout(()=>{this.clickTimeout=null},300),e.apply(this,t)},selectFlow(e){var t;((t=this.selectedFlow)==null?void 0:t.id)!==e.id&&(this.selectedFlow=e)},createFlow(){this.showNewFlowModal=!0},editFlow(e){this.editingFlow={...e},this.showEditFlowModal=!0},async saveFlow(){var e,t,n,d;if(this.errors.flow={name:"",description:"",status:""},!this.flowName.trim()){this.errors.flow.name="Flow name is required";return}try{const l=this.editingFlow?this.editingFlow:this.newFlow,i={name:l.name,description:l.description||"",status:l.status||"draft"};if(this.editingFlow){const w=await b.put(`/flows/${this.editingFlow.id}`,i);this.flows=this.flows.map(p=>p.id===w.data.id?w.data:p)}else{const w=await b.post("/flows",i);this.flows.push(w.data)}this.showNewFlowModal=!1,this.showEditFlowModal=!1,this.editingFlow=null,this.newFlow={name:"",description:"",status:"draft"}}catch(l){(t=(e=l.response)==null?void 0:e.data)!=null&&t.errors?this.errors.flow=l.response.data.errors:(console.error("Error saving flow:",l),alert(((d=(n=l.response)==null?void 0:n.data)==null?void 0:d.message)||"Failed to save flow"))}},confirmDelete(e,t){S.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#34c38f",cancelButtonColor:"#f46a6a",confirmButtonText:"Yes, delete it!"}).then(n=>{n.isConfirmed&&this.handleDelete(e,t)})},async handleDelete(e,t){var n,d,l;if(!(!e||!t)){this.isDeleting=!0;try{if(t==="flow")await b.delete(`/flows/${e.id}`),((n=this.selectedFlow)==null?void 0:n.id)===e.id&&(this.selectedFlow=null),await this.refreshFlows(),this.showSuccessAlert("Flow deleted successfully");else if(t==="email"){const i=this.selectedFlow.emails.filter(w=>w.id!==e.id);this.updateFlowEmails(i),await b.delete(`/flows/${this.selectedFlow.id}/emails/${e.id}`),this.showSuccessAlert("Email deleted successfully")}}catch(i){console.error(`Error deleting ${t}:`,i),this.showErrorAlert(((l=(d=i.response)==null?void 0:d.data)==null?void 0:l.message)||`Failed to delete ${t}`),t==="email"&&await this.refreshFlows()}finally{this.isDeleting=!1}}},showSuccessAlert(e){S.fire({title:"Success!",text:e,icon:"success",showConfirmButton:!1,timer:1500,timerProgressBar:!0})},showErrorAlert(e){S.fire({title:"Error!",text:e,icon:"error",confirmButtonColor:"#34c38f",confirmButtonText:"Ok"})},async clearImage(){var t,n,d;if((t=this.editingEmail)!=null&&t.image_path)try{await b.post(`/flows/${this.selectedFlow.id}/emails/${this.editingEmail.id}/remove-image`),this.editingEmail.image_path=null}catch(l){console.error("Error removing image:",l),this.showErrorAlert(((d=(n=l.response)==null?void 0:n.data)==null?void 0:d.message)||"Failed to remove image");return}this.selectedImage=null,this.imagePreview=null;const e=this.$refs.imageInput;e&&(e.value="")},async saveEmail(){var e,t,n,d;if(!this.isSaving)try{if(!this.emailName.trim()){this.showErrorAlert("Email name is required");return}if(!this.emailSubject.trim()){this.showErrorAlert("Subject is required");return}if(!this.emailDelay.trim()){this.showErrorAlert("Delay is required");return}if(!this.emailDelay.trim().match(/^(immediately|(\d+(-\d+)?\s+(hours?|days?)\s+after))$/)){this.showErrorAlert('Delay must be in format "immediately", "X hours after", "X days after" or "X-Y days/hours after"');return}this.isSaving=!0;const l=new FormData;l.append("name",this.emailName.trim()),l.append("subject",this.emailSubject.trim()),l.append("delay",this.emailDelay.trim()),this.selectedImage&&l.append("image",this.selectedImage);const i=!!this.editingEmail,w=`/flows/${this.selectedFlow.id}/emails${i?`/${this.editingEmail.id}`:""}`;let p;i?(l.append("_method","PUT"),p=await b.post(w,l,{headers:{"Content-Type":"multipart/form-data"}})):p=await b.post(w,l,{headers:{"Content-Type":"multipart/form-data"}});const g=i?this.selectedFlow.emails.map(y=>y.id===this.editingEmail.id?p.data:y):[...this.selectedFlow.emails,p.data];this.updateFlowEmails(g),this.resetEmailForm(),this.showSuccessAlert(i?"Email updated successfully":"Email added successfully",i?"Updated!":"Added!")}catch(l){console.error("Error saving email:",l);const i=((t=(e=l.response)==null?void 0:e.data)==null?void 0:t.message)||((d=(n=l.response)==null?void 0:n.data)==null?void 0:d.error)||l.message||"Failed to save email";this.showErrorAlert(`Error: ${i}`)}finally{this.isSaving=!1}},addEmailToFlow(){this.newEmail={name:"",subject:"",delay:"",template:"default"},this.editingEmail=null,this.errors.email={name:"",subject:"",delay:"",template:""},this.showNewEmailModal=!0},editEmail(e){this.editingEmail={...e},this.showEditEmailModal=!0},handleImageSelect(e){const t=e.target.files[0];t&&(this.selectedImage=t,this.imagePreview=URL.createObjectURL(t))},handleImageError(e){e.target.src=this.defaultImage},async deleteEmail(e){if(this.isDeleting||!confirm("Are you sure you want to delete this email?"))return;this.isDeleting=!0;const t=e.id,n=this.selectedFlow.id,d=this.selectedFlow.emails.filter(l=>l.id!==t);this.updateFlowEmails(d);try{await b.delete(`/flows/${n}/emails/${t}`)}catch(l){console.error("Error deleting email:",l),await this.refreshFlows(),alert("Failed to delete email")}finally{this.isDeleting=!1}},async refreshFlows(){try{const e=await b.get("/flows");if(this.flows=e.data,this.selectedFlow){const t=this.flows.find(n=>n.id===this.selectedFlow.id);this.selectedFlow=t||null}}catch(e){console.error("Error refreshing flows:",e),alert("Failed to load flows. Please refresh the page.")}},getEmailStats(e){return e.stats||{sent:0,opened:0,clicked:0}},updateFlowEmails(e){this.selectedFlow&&(this.selectedFlow={...this.selectedFlow,emails:e},this.flows=this.flows.map(t=>t.id===this.selectedFlow.id?this.selectedFlow:t))},resetEmailForm(){this.showNewEmailModal=!1,this.showEditEmailModal=!1,this.editingEmail=null,this.newEmail={name:"",subject:"",delay:"",template:"default"},this.errors.email={name:"",subject:"",delay:"",template:""},this.clearImage()},debounce(e,t=300){let n;return function(...l){const i=()=>{clearTimeout(n),e.apply(this,l)};clearTimeout(n),n=setTimeout(i,t)}},viewEmailTemplate(e){this.currentPreviewEmailIndex=this.selectedFlow.emails.findIndex(t=>t.id===e.id),this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage,this.showImagePreviewModal=!0},showPreviousEmail(){if(this.hasPreviousEmail){this.currentPreviewEmailIndex--;const e=this.selectedFlow.emails[this.currentPreviewEmailIndex];this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage}},showNextEmail(){if(this.hasNextEmail){this.currentPreviewEmailIndex++;const e=this.selectedFlow.emails[this.currentPreviewEmailIndex];this.previewImageTitle=e.name,this.previewImageUrl=e.image_path?`/storage/${e.image_path}`:this.defaultImage}},formatDelay(e){if(!e)return"";try{if(e==="immediately")return"Sends immediately";if(typeof e=="string"&&e.includes("-")){const[t,n]=e.split("-"),[d,l,...i]=n.trim().split(" ");return`${l.charAt(0).toUpperCase()+l.slice(1)} ${t.trim()}-${d} ${i.join(" ")}`}return e}catch(t){return console.error("Error formatting delay:",t),e}},handleFlowClick(e){if(this.clickTimeout){clearTimeout(this.clickTimeout),this.clickTimeout=null;return}this.clickTimeout=setTimeout(()=>{this.clickTimeout=null,this.selectedFlow=e},200)},changePage(e){this.currentPage=e}},created(){this.debouncedRefreshFlows=this.debounce(this.refreshFlows)},watch:{searchTerm(){this.currentPage=1}}},ze={class:"d-flex gap-2"},He={class:"search-box"},Ge={class:"flow-cards-container"},Oe=["onClick"],Ke={class:"p-4"},Je={class:"card-content"},Qe={class:"fs-14 mb-3 text-end text-truncate"},$e={class:"mb-0 description-text"},et={class:"d-flex align-items-center justify-content-between mt-auto"},tt={class:"text-muted"},it={key:0,class:"text-center w-100 py-5"},lt={class:"text-muted"},st={key:0,class:"d-flex justify-content-center mt-4"};function at(e,t,n,d,l,i){const w=m("PageHeader"),p=m("BButton"),g=m("BCol"),y=m("BInputGroupPrepend"),k=m("BFormInput"),x=m("BInputGroup"),D=m("BRow"),j=m("BDropdownItem"),I=m("BDropdown"),C=m("BCard"),F=m("BPagination"),U=m("BCardBody"),Y=m("FlowEmails"),V=m("BFormInvalidFeedback"),o=m("BFormGroup"),v=m("BFormTextarea"),P=m("BFormSelect"),L=m("BForm"),A=m("BModal"),Z=m("Layout");return c(),B(Z,null,{default:r(()=>[a(w,{title:"Email Flows",pageTitle:"Apps"}),a(D,{class:"g-4 mb-3"},{default:r(()=>[a(g,{sm:"auto"},{default:r(()=>[s("div",ze,[a(p,{variant:"primary",onClick:t[0]||(t[0]=h=>l.showNewFlowModal=!0)},{default:r(()=>t[8]||(t[8]=[s("i",{class:"ri-add-line align-bottom me-1"},null,-1),_(" Add New Flow ")])),_:1})])]),_:1}),a(g,{sm:""},{default:r(()=>[s("div",He,[a(x,null,{default:r(()=>[a(y,null,{default:r(()=>[a(p,{variant:"primary"},{default:r(()=>t[9]||(t[9]=[s("i",{class:"ri-search-line search-icon text-white"},null,-1)])),_:1})]),_:1}),a(k,{modelValue:l.searchTerm,"onUpdate:modelValue":t[1]||(t[1]=h=>l.searchTerm=h),type:"text",placeholder:"Search flows...",class:"search-input"},null,8,["modelValue"])]),_:1})])]),_:1})]),_:1}),a(D,{class:"mb-4"},{default:r(()=>[a(g,{lg:"12"},{default:r(()=>[a(C,{"no-body":""},{default:r(()=>[a(U,null,{default:r(()=>[s("div",Ge,[(c(!0),E(R,null,z(i.paginatedFlows,h=>(c(),E("div",{key:h.id,class:"ribbon-box cursor-pointer",onClick:T=>i.handleFlowClick(h)},[a(C,{"no-body":""},{default:r(()=>{var T,M,W;return[s("div",{class:N(["ribbon-two",{"ribbon-two-info":((T=l.selectedFlow)==null?void 0:T.id)!==h.id,"ribbon-two-secondary":((M=l.selectedFlow)==null?void 0:M.id)===h.id}])},[s("span",null,u(h.status),1)],2),s("div",Ke,[s("div",Je,[s("h5",Qe,u(h.name),1),s("p",$e,u(h.description),1),s("div",et,[s("div",null,[t[10]||(t[10]=s("i",{class:"ri-mail-send-line me-2"},null,-1)),s("small",tt,u(((W=h.emails)==null?void 0:W.length)||0)+" emails in sequence",1)]),a(I,{variant:"link","toggle-class":"btn btn-soft-primary btn-sm arrow-none","menu-class":"dropdown-menu-end"},{"button-content":r(()=>t[11]||(t[11]=[s("i",{class:"ri-more-2-fill"},null,-1)])),default:r(()=>[a(j,{onClick:q(G=>i.editFlow(h),["stop"])},{default:r(()=>t[12]||(t[12]=[s("i",{class:"ri-edit-line align-bottom me-2 text-muted"},null,-1),_("Edit ")])),_:2},1032,["onClick"]),a(j,{onClick:q(G=>i.confirmDelete(h,"flow"),["stop"]),disabled:l.isDeleting,class:"text-danger"},{default:r(()=>t[13]||(t[13]=[s("i",{class:"ri-delete-bin-line align-bottom me-2 text-muted"},null,-1),_("Delete ")])),_:2},1032,["onClick","disabled"])]),_:2},1024)])])])]}),_:2},1024)],8,Oe))),128)),(l.searchTerm?i.filteredFlows:i.paginatedFlows).length===0?(c(),E("div",it,[t[14]||(t[14]=s("div",{class:"avatar-lg mx-auto mb-4"},[s("div",{class:"avatar-title text-primary display-5 rounded-circle"},[s("i",{class:"ri-search-line"})])],-1)),t[15]||(t[15]=s("h5",null,"No flows found",-1)),s("p",lt,u(l.searchTerm?"Try adjusting your search term":"Start by creating a new flow"),1)])):f("",!0)]),i.showPagination?(c(),E("div",st,[a(F,{modelValue:l.currentPage,"onUpdate:modelValue":t[2]||(t[2]=h=>l.currentPage=h),"total-rows":l.flows.length,"per-page":l.perPage,align:"center",class:"mb-0"},{"prev-text":r(()=>t[16]||(t[16]=[s("i",{class:"ri-arrow-left-s-line"},null,-1)])),"next-text":r(()=>t[17]||(t[17]=[s("i",{class:"ri-arrow-right-s-line"},null,-1)])),_:1},8,["modelValue","total-rows","per-page"])])):f("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),l.selectedFlow?(c(),B(Y,{key:0,selectedFlow:l.selectedFlow,"onUpdate:emails":i.updateFlowEmails,onRefresh:i.refreshFlows},null,8,["selectedFlow","onUpdate:emails","onRefresh"])):f("",!0),a(A,{modelValue:l.showNewFlowModal||l.showEditFlowModal,title:l.editingFlow?"Edit Flow":"Create New Flow",onHide:t[7]||(t[7]=h=>l.showNewFlowModal=l.showEditFlowModal=!1)},{footer:r(()=>[a(p,{variant:"secondary",onClick:t[6]||(t[6]=h=>l.showNewFlowModal=l.showEditFlowModal=!1)},{default:r(()=>t[18]||(t[18]=[_(" Cancel ")])),_:1}),a(p,{variant:"primary",onClick:i.saveFlow},{default:r(()=>[_(u(l.editingFlow?"Update":"Create"),1)]),_:1},8,["onClick"])]),default:r(()=>[a(L,null,{default:r(()=>[a(o,{label:"Flow Name*",class:"mb-4"},{default:r(()=>[a(k,{modelValue:i.flowName,"onUpdate:modelValue":t[3]||(t[3]=h=>i.flowName=h),placeholder:"Enter flow name",state:l.errors.flow.name?!1:null},null,8,["modelValue","state"]),l.errors.flow.name?(c(),B(V,{key:0},{default:r(()=>[_(u(l.errors.flow.name),1)]),_:1})):f("",!0)]),_:1}),a(o,{label:"Description",class:"mb-4"},{default:r(()=>[a(v,{modelValue:i.flowDescription,"onUpdate:modelValue":t[4]||(t[4]=h=>i.flowDescription=h),placeholder:"Enter flow description",state:l.errors.flow.description?!1:null},null,8,["modelValue","state"]),l.errors.flow.description?(c(),B(V,{key:0},{default:r(()=>[_(u(l.errors.flow.description),1)]),_:1})):f("",!0)]),_:1}),a(o,{label:"Status*"},{default:r(()=>[a(P,{modelValue:i.flowStatus,"onUpdate:modelValue":t[5]||(t[5]=h=>i.flowStatus=h),options:["draft","active"],state:l.errors.flow.status?!1:null},null,8,["modelValue","state"]),l.errors.flow.status?(c(),B(V,{key:0},{default:r(()=>[_(u(l.errors.flow.status),1)]),_:1})):f("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]),_:1})}const _t=H(qe,[["render",at],["__scopeId","data-v-060645d4"]]);export{_t as default};
