import{_ as D}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{o as x,d as C}from"./app-BWABJYdq.js";class A{constructor(){this.viz=null,this.isScriptLoaded=!1,this.isVizReady=!1}async loadTableauScript(){return new Promise((t,r)=>{if(document.querySelector('script[src*="tableau.embedding"]')){this.isScriptLoaded=!0,t(!0);return}const s=document.createElement("script");s.type="module",s.src="https://us-west-2b.online.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js",s.async=!0,s.addEventListener("load",()=>{this.isScriptLoaded=!0,t(!0)}),s.addEventListener("error",a=>{console.error("❌ Failed to load Tableau script:",a),r(a)}),document.head.appendChild(s)})}handleVizInit(t){var r;return t?(this.viz=t,(r=this.viz)!=null&&r.workbook?(this.isVizReady=!0,!0):(console.warn("⚠ Tableau workbook not ready yet"),!1)):(console.warn("⚠ No viz element provided"),!1)}applyFilter(t,r){var l,s;if(!this.isVizReady||!((l=this.viz)!=null&&l.workbook))return console.warn("⚠ Tableau is not fully initialized yet. Skipping filter application."),!1;try{const a=this.viz.workbook.activeSheet,i=(s=a.worksheets)==null?void 0:s.find(d=>d.name==="updated Email metrics");return Array.isArray(r)?t==="Campaign Name"?a.applyFilterAsync(t,r.filter(Boolean),"replace"):t==="Date"?i&&r[0]instanceof Date&&r[1]instanceof Date&&i.applyRangeFilterAsync("Date",{min:r[0],max:r[1]}):a.applyFilterAsync(t,r,"replace"):r===null?this.clearFilter(t):r==="All"?a.applyFilterAsync(t,[],"all"):a.applyFilterAsync(t,[r],"replace"),!0}catch(a){return console.error(`❌ Error applying filter ${t}:`,a),!1}}clearFilter(t){var r,l;if(!this.isVizReady||!((r=this.viz)!=null&&r.workbook))return console.warn("⚠ Tableau not fully initialized yet. Cannot clear filter."),!1;try{const s=this.viz.workbook.activeSheet,a=(l=s.worksheets)==null?void 0:l.find(i=>i.name==="updated Email metrics");return t==="Date"?a&&a.clearFilterAsync("Date"):s.applyFilterAsync(t,[],"all"),!0}catch(s){return console.error(`❌ Error clearing filter ${t}:`,s),!1}}clearAllFilters(t){return Array.isArray(t)?t.every(r=>this.clearFilter(r)):(console.warn("⚠ filterNames must be an array"),!1)}isTableauReady(){return this.isVizReady&&this.viz&&this.viz.workbook}async getCampaignNames(){var t,r,l,s,a,i,d,z,m;if(!this.isVizReady||!((t=this.viz)!=null&&t.workbook))return console.warn("⚠ Tableau is not fully initialized yet."),[];try{const _=this.viz.workbook.activeSheet.worksheets||[];for(const w of _)try{const e=await w.getSummaryDataAsync({ignoreSelection:!0,includeAllColumns:!0});let n=[];typeof e.getColumns=="function"?n=e.getColumns():e.columns&&(n=e.columns);const c=((r=e.getData)==null?void 0:r.call(e))||e.data||[];if(c.length>0){const p=c[0],v=n.reduce((y,u,h)=>{var q;const g=((q=p[h])==null?void 0:q.value)||p[h];return y[u.fieldName||u._fieldName]=g,y},{})}const b=n.find(p=>(p._fieldName||p.fieldName||"")==="Campaign Name");if(b){const p=new Set,v=b._index||b.index;if(c.forEach(y=>{const u=y[v],h=(u==null?void 0:u.formattedValue)||(u==null?void 0:u.value)||u;if(h&&typeof h=="string"){const g=h.trim();g&&p.add(g)}}),p.size>0)return Array.from(p).filter(Boolean).sort((u,h)=>u.localeCompare(h))}}catch(e){console.warn(`⚠ Error processing sheet ${w.name}:`,e);continue}return console.error("❌ No campaign data found in any sheet"),[]}catch(k){return console.error("❌ Error retrieving campaign names:",k),console.error("Debug info:",{dashboardName:(a=(s=(l=this.viz)==null?void 0:l.workbook)==null?void 0:s.activeSheet)==null?void 0:a.name,sheetCount:(m=(z=(d=(i=this.viz)==null?void 0:i.workbook)==null?void 0:d.activeSheet)==null?void 0:z.worksheets)==null?void 0:m.length,error:k.toString()}),[]}}async getAvailableFields(){var t;if(!this.isVizReady||!((t=this.viz)!=null&&t.workbook))return[];try{const l=this.viz.workbook.activeSheet.worksheets||[];for(const a of l)try{const i=await a.getSummaryDataAsync({ignoreSelection:!0,includeAllColumns:!0});let d=[];i.data&&i.columns?d=i.columns:typeof i.getColumns=="function"&&(d=i.getColumns())}catch(i){console.warn(`⚠ Error getting fields from ${a.name}:`,i)}const s=l[0];if(s){const a=await s.getSummaryDataAsync({ignoreSelection:!0,includeAllColumns:!0});let i=[];return a.data&&a.columns?i=a.columns:typeof a.getColumns=="function"&&(i=a.getColumns()),i}}catch(r){return console.error("Error getting fields:",r),[]}}async getCampaignMetrics(t){var r,l,s;if(!this.isVizReady||!((r=this.viz)!=null&&r.workbook))return console.warn("⚠ Tableau is not fully initialized yet."),null;try{const a=(l=this.viz.workbook.activeSheet.worksheets)==null?void 0:l.find(e=>e.name==="updated Email metrics");if(!a)return console.warn("⚠ Could not find 'updated Email metrics' worksheet"),null;const i=await a.getSummaryDataAsync({ignoreSelection:!0,includeAllColumns:!0});let d=[];i.data&&i.columns?d=i.columns:typeof i.getColumns=="function"&&(d=i.getColumns());const z=((s=i.getData)==null?void 0:s.call(i))||i.data||[],m={campaignName:d.findIndex(e=>(e.fieldName||e._fieldName)==="Campaign Name"),monthDate:d.findIndex(e=>(e.fieldName||e._fieldName)==="MONTH(Date)"),dayDate:d.findIndex(e=>(e.fieldName||e._fieldName)==="DAY(Date)"),measureName:d.findIndex(e=>(e.fieldName||e._fieldName)==="Measure Names"),measureValue:d.findIndex(e=>(e.fieldName||e._fieldName)==="Measure Values")},k=new Set;z.forEach(e=>{var c;const n=((c=e[m.measureName])==null?void 0:c.value)||e[m.measureName];n&&k.add(n)});const _={"[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[sum:iterable_total_sends:qk]":"totalSends","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[sum:iterable_total_delivered:qk]":"totalDelivered","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[usr:Calculation_5980217412463558656:qk]":"deliveryRate","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[sum:iterable_unique_open_clicks:qk]":"uniqueOpenClicks","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[usr:Calculation_5980217412465033217:qk]":"openRate","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[sum:iterable_total_clicks:qk]":"totalClicks","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[usr:Calculation_5980217412465561603:qk]":"clickToOpenRate","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[usr:Calculation_6445988101634551831:qk]":"clickThruRate","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[sum:iterable_unique_unsubscribers:qk]":"uniqueUnsubscribers","[sqlproxy.1vwal861d5yr5z1czsxwq1r00p81].[usr:Calculation_5980217412465774596:qk]":"unsubscribeRate","[sqlproxy.09i8w5x0dt0zvw12du3qz01vxoid].[sum:entries:qk]":"entries","[sqlproxy.09i8w5x0dt0zvw12du3qz01vxoid].[sum:Calculation_1905304177753239555:qk]":"totalLeads","[sqlproxy.09i8w5x0dt0zvw12du3qz01vxoid].[sum:c. total leads (copy)_1905304177754034180:qk]":"dealerLeads","[sqlproxy.09i8w5x0dt0zvw12du3qz01vxoid].[usr:Calculation_1362620364465704960:qk]":"conversion"},w=z.reduce((e,n)=>{var g,q,N,S,F;const c=((g=n[m.campaignName])==null?void 0:g.value)||n[m.campaignName],b=Number(((q=n[m.monthDate])==null?void 0:q.value)||n[m.monthDate])||0,p=Number(((N=n[m.dayDate])==null?void 0:N.value)||n[m.dayDate])||0,v=((S=n[m.measureName])==null?void 0:S.value)||n[m.measureName],y=Number(((F=n[m.measureValue])==null?void 0:F.value)||n[m.measureValue])||0;if(!t.includes(c))return e;e[c]||(e[c]={dailyMetrics:{},totals:{emails_delivered:0,entries:0,leads:0},rates:{conversion_rate:0},trends:{delivery_rate:0,entry_rate:0,lead_rate:0,conversion_trend:0}});const u=`${b}-${p}`;e[c].dailyMetrics[u]||(e[c].dailyMetrics[u]={monthDate:b,dayDate:p,metrics:{}});const h=_[v];if(h)switch(e[c].dailyMetrics[u].metrics[h]=y,h){case"totalDelivered":e[c].totals.emails_delivered+=y;break;case"entries":e[c].totals.entries+=y;break;case"totalLeads":e[c].totals.leads+=y;break}return e},{});return Object.keys(w).forEach(e=>{const n=w[e];n.rates.conversion_rate=n.totals.entries>0?n.totals.leads/n.totals.entries*100:0}),w}catch(a){return console.error("❌ Error getting campaign metrics:",a),null}}}const f=new A,V={name:"TableauDashboard",props:{width:{type:[String,Number],default:"100%"},height:{type:[String,Number],default:"800"},vizUrl:{type:String,required:!0}},data(){return{isScriptLoaded:!1,pendingFilters:[],isVizReady:!1}},watch:{isVizReady(o){this.$emit("loading",!o)}},computed:{},async mounted(){try{await f.loadTableauScript(),this.isScriptLoaded=!0,console.log("✅ Tableau script loaded, waiting for viz initialization...")}catch(o){console.error("Failed to initialize Tableau:",o)}},methods:{async handleFirstInteractive(o){f.handleVizInit(o.target)&&(this.isVizReady=!0,console.log("✅ Tableau viz is ready"),await this.refreshCampaigns())},async updateCampaignNames(){const o=await f.getCampaignNames();o.length>0&&this.$emit("campaign-names-updated",o)},applyFilter(o,t){if(!this.isVizReady){this.pendingFilters.push({fieldName:o,value:t});return}return f.applyFilter(o,t)},clearFilter(o){if(!this.isVizReady){this.pendingFilters=this.pendingFilters.filter(t=>t.fieldName!==o);return}return f.clearFilter(o)},handleFilterChange(o){},async refreshCampaigns(){const o=await f.getCampaignNames();return this.$emit("campaign-names-updated",o),o},async getAvailableFields(){return f.getAvailableFields()},getCampaignMetrics(o){return f.getCampaignMetrics(o)}}},R={class:"tableau-container"},T=["src","width","height"],E={key:1,class:"loading"};function M(o,t,r,l,s,a){return x(),C("div",R,[s.isScriptLoaded?(x(),C("tableau-viz",{key:0,ref:"tableauViz",id:"tableau-viz",src:r.vizUrl,width:r.width,height:r.height,toolbar:"bottom",onFirstinteractive:t[0]||(t[0]=(...i)=>a.handleFirstInteractive&&a.handleFirstInteractive(...i)),onFilterChange:t[1]||(t[1]=(...i)=>a.handleFilterChange&&a.handleFilterChange(...i))},null,40,T)):(x(),C("div",E," Loading Tableau Dashboard... "))])}const $=D(V,[["render",M],["__scopeId","data-v-3ad81321"]]);export{$ as T,f as t};
